<!DOCTYPE html>
<html>
<head>
  <title>index.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../";
    var thisFile = "home/alex/github/node-mailman/src/index.coffee";
    var defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0" /></head>
<body>
  <nav>
<div class="logo"><a href="http://alinex.github.io"
  onmouseover="logo.src='https://alinex.github.io/images/Alinex-200.png'"
  onmouseout="logo.src='https://alinex.github.io/images/Alinex-black-200.png'">
  <img name="logo" src="https://alinex.github.io/images/Alinex-black-200.png"
    width="150" title="Alinex Universe Homepage" />
  </a>
  <img src="http://alinex.github.io/images/Alinex-200.png"
    style="display:none" alt="preloading" />
</div>
<div class="links">
  <a href="http://alinex.github.io/blog"
    class="btn btn-primary"><span class="glyphicon-pencil"></span> Blog</a>
  <a href="http://alinex.github.io/develop"
    class="btn btn-primary"><span class="glyphicon-book"></span> Develop</a>
  <a href="http://alinex.github.io/code.html"
    class="btn btn-warning"><span class="glyphicon-cog"></span> Code</a>
</div>
</nav><div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#main-controlling-class">Main controlling class</a>
      </div>

      <div class="heading h2">
        <a href="#node-modules">Node Modules</a>
      </div>

      <div class="heading h2">
        <a href="#initialized-data">Initialized Data</a>
      </div>

      <div class="heading h3">
        <a href="#general-mode">General Mode</a>
      </div>

      <div class="heading h2">
        <a href="#run-mailman">Run Mailman</a>
      </div>

      <div class="heading h2">
        <a href="#helper-methods">Helper Methods</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-mailman" title="Fork me on GitHub"></a>
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="main-controlling-class">
  <h1>
    <a href="#main-controlling-class" name="main-controlling-class" class="pilcrow"></a>
Main controlling class
  </h1>
</div>
<p>This is the real main class which can be called using it's API. Other modules
like the cli may be used as bridges to this.</p>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="node-modules">
  <h2>
    <a href="#node-modules" name="node-modules" class="pilcrow"></a>
Node Modules
  </h2>
</div>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>include base modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'mailman'</span>)
chalk = <span class="hljs-built_in">require</span> <span class="hljs-string">'chalk'</span>
util = <span class="hljs-built_in">require</span> <span class="hljs-string">'util'</span>
Imap = <span class="hljs-built_in">require</span> <span class="hljs-string">'imap'</span>
MailParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mailparser'</span>).MailParser</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>include alinex modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">config = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-config'</span>
Exec = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-exec'</span>
{object} = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-util'</span>
async = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-async'</span>
mail = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-mail'</span>
validator = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-validator'</span>
Report = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-report'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>include classes and helpers</p>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="initialized-data">
  <h2>
    <a href="#initialized-data" name="initialized-data" class="pilcrow"></a>
Initialized Data
  </h2>
</div>
<p>This will be set on init</p>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="general-mode">
  <h3>
    <a href="#general-mode" name="general-mode" class="pilcrow"></a>
General Mode
  </h3>
</div>
<p>This is a collection of base settings which may alter the runtime of the system
without changing anything in the general configuration. This values may also
be changed at any time.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">mode =
  <span class="hljs-attribute">try</span>: <span class="hljs-literal">false</span> <span class="hljs-comment"># work in try mode</span>
  <span class="hljs-attribute">daemon</span>: <span class="hljs-literal">false</span> <span class="hljs-comment"># runs in daemon mode?</span>

imap = <span class="hljs-literal">null</span> <span class="hljs-comment"># imap connection</span>
numJobs = <span class="hljs-number">0</span> <span class="hljs-comment"># number of jobs in progress</span>

exports.init = <span class="hljs-function"><span class="hljs-params">(setup)</span> -&gt;</span>
  mode = setup</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="run-mailman">
  <h2>
    <a href="#run-mailman" name="run-mailman" class="pilcrow"></a>
Run Mailman
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">exports.run = <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span>
  numJobs = <span class="hljs-number">0</span>
  <span class="hljs-built_in">console</span>.log <span class="hljs-string">"check for commands on mailbox"</span>
  debug <span class="hljs-string">"connect to mailserver..."</span>
  setup = config.get <span class="hljs-string">'/mailman/mailcheck'</span>
  imap = <span class="hljs-keyword">new</span> Imap setup
  imap.once <span class="hljs-string">'ready'</span>, <span class="hljs-function">-&gt;</span> openBox (err, box) -&gt;
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
    processMails box, <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
      imap.end()
      cb err
  imap.once <span class="hljs-string">'error'</span>, cb
  imap.once <span class="hljs-string">'end'</span>, <span class="hljs-function">-&gt;</span>
    debug <span class="hljs-string">'mailserver connection ended'</span>
  imap.connect()</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="helper-methods">
  <h2>
    <a href="#helper-methods" name="helper-methods" class="pilcrow"></a>
Helper Methods
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">openBox</span> = <span class="hljs-params">(cb)</span> -&gt;</span>
  debug <span class="hljs-string">"open INBOX..."</span>
  imap.status <span class="hljs-string">'INBOX'</span>, <span class="hljs-function"><span class="hljs-params">(err, box)</span> -&gt;</span>
    debug <span class="hljs-string">"found <span class="hljs-subst">#{box.messages.total}</span> messages (<span class="hljs-subst">#{box.messages.unseen}</span> unread)"</span>
  imap.openBox <span class="hljs-string">'INBOX'</span>, mode.<span class="hljs-keyword">try</span>, cb
<span class="hljs-function">
<span class="hljs-title">processMails</span> = <span class="hljs-params">(box, cb)</span> -&gt;</span>
  commands = config.get <span class="hljs-string">'/mailman/command'</span>
  async.eachOf commands, <span class="hljs-function"><span class="hljs-params">(setup, command, cb)</span> -&gt;</span>
    debug <span class="hljs-string">"<span class="hljs-subst">#{chalk.grey command}</span> search mails..."</span>
    criteria = [<span class="hljs-string">'UNSEEN'</span>, [<span class="hljs-string">'!HEADER'</span>, <span class="hljs-string">'INREPLYTO'</span>, <span class="hljs-string">''</span>]]
    <span class="hljs-keyword">if</span> setup.filter?.subject
      criteria.push [<span class="hljs-string">'SUBJECT'</span>, setup.filter.subject]
    debug chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{command}</span> use filter <span class="hljs-subst">#{util.inspect(criteria).replace <span class="hljs-regexp">/\s+/g</span>, <span class="hljs-string">' '</span>}</span>"</span>
    error = <span class="hljs-literal">null</span>
    imap.search criteria, <span class="hljs-function"><span class="hljs-params">(err, results)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
      count = results.length
      debug <span class="hljs-string">"<span class="hljs-subst">#{chalk.grey command}</span> found <span class="hljs-subst">#{count}</span> messages"</span>
      <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> count
      f = imap.fetch results,
        <span class="hljs-attribute">bodies</span>: [<span class="hljs-string">'HEADER'</span>, <span class="hljs-string">'TEXT'</span>]
        <span class="hljs-attribute">markSeen</span>: <span class="hljs-literal">true</span>
      f.<span class="hljs-literal">on</span> <span class="hljs-string">'message'</span>, <span class="hljs-function"><span class="hljs-params">(msg, seqno)</span> -&gt;</span>
        debug <span class="hljs-string">"<span class="hljs-subst">#{chalk.grey command}</span> read message #<span class="hljs-subst">#{seqno}</span>"</span>
        mailparser = <span class="hljs-keyword">new</span> MailParser()
        mailparser.<span class="hljs-literal">on</span> <span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-params">(obj)</span> -&gt;</span>
          execute
            <span class="hljs-attribute">header</span>: obj.headers
            <span class="hljs-attribute">body</span>:
              <span class="hljs-attribute">html</span>: obj.html
              <span class="hljs-attribute">text</span>: obj.text
          , command, setup, <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
            <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
            count--</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<pre><code>   attrs = null
</code></pre>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        msg.<span class="hljs-literal">on</span> <span class="hljs-string">'body'</span>, <span class="hljs-function"><span class="hljs-params">(stream)</span> -&gt;</span>
          stream.<span class="hljs-literal">on</span> <span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-params">(chunk)</span> -&gt;</span>
            mailparser.write chunk.toString <span class="hljs-string">'utf8'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<pre><code>   msg.once 'attributes', (data) -&gt;
     attrs = data
     debug &quot;#{chalk.grey command + ' #' + seqno} attributes: #{util.inspect attrs}&quot;
</code></pre>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        msg.once <span class="hljs-string">'end'</span>, <span class="hljs-function">-&gt;</span>
          debug <span class="hljs-string">"<span class="hljs-subst">#{chalk.grey command}</span> end reading <span class="hljs-subst">#{seqno}</span>"</span>
          mailparser.end()
      f.once <span class="hljs-string">'error'</span>, <span class="hljs-function">-&gt;</span>
        error = <span class="hljs-keyword">new</span> Error <span class="hljs-string">"IMAP Fetch error: <span class="hljs-subst">#{err.message}</span>"</span>
      f.once <span class="hljs-string">'end'</span>, <span class="hljs-function">-&gt;</span>
        debug <span class="hljs-string">"<span class="hljs-subst">#{chalk.grey command}</span> no more messages"</span>
        <span class="hljs-keyword">return</span> cb error <span class="hljs-keyword">if</span> error</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>wait for finishing execution</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function">        <span class="hljs-title">done</span> = -&gt;</span>
          <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> count
          setTimeout done, <span class="hljs-number">1000</span>
        done()
  , cb
<span class="hljs-function">
<span class="hljs-title">bodyVariables</span> = <span class="hljs-params">(conf, body, cb)</span> -&gt;</span>
  <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> conf.variables
  body = <span class="hljs-keyword">unless</span> body.html
    body.text.trim()
  <span class="hljs-keyword">else</span>
    <span class="hljs-built_in">require</span>(<span class="hljs-string">'html2plaintext'</span>) body.html
  <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> body</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>use only the code till the first empty line</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  lines = []</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>for l in string.toList body</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">for</span> l <span class="hljs-keyword">in</span> body.split <span class="hljs-regexp">/\n/</span>
    <span class="hljs-keyword">break</span> <span class="hljs-keyword">unless</span> l.trim()
    lines.push l</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>parse ini format</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  ini = <span class="hljs-built_in">require</span> <span class="hljs-string">'ini'</span>
  <span class="hljs-keyword">try</span>
    obj = ini.decode lines.join <span class="hljs-string">'\n'</span>
  <span class="hljs-keyword">catch</span> error
    <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">"ini parser: <span class="hljs-subst">#{error.message}</span>"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>detect failed parsing</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> obj?
    <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">"ini parser: could not parse any result"</span>
  <span class="hljs-keyword">if</span> obj[<span class="hljs-string">'{'</span>]
    <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">"ini parser: Unexpected token { at start"</span>
  <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> obj
    <span class="hljs-keyword">if</span> v <span class="hljs-keyword">is</span> <span class="hljs-literal">true</span> <span class="hljs-keyword">and</span> k.match <span class="hljs-regexp">/:/</span>
      <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">"ini parser: Unexpected key name containing
      ':' with value true"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>validate variables
obj = object.lcKeys obj</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">delete</span> obj[key] <span class="hljs-keyword">unless</span> conf.variables[key] <span class="hljs-keyword">for</span> key <span class="hljs-keyword">of</span> obj
  validator.check
    <span class="hljs-attribute">name</span>: <span class="hljs-string">'emailBody'</span>
    <span class="hljs-attribute">value</span>: obj
    <span class="hljs-attribute">schema</span>:
      <span class="hljs-attribute">type</span>: <span class="hljs-string">'object'</span>
      <span class="hljs-attribute">allowedKeys</span>: <span class="hljs-literal">true</span>
      <span class="hljs-attribute">mandatoryKeys</span>: <span class="hljs-literal">true</span>
      <span class="hljs-attribute">keys</span>: conf.variables
  , cb
<span class="hljs-function">
<span class="hljs-title">execute</span> = <span class="hljs-params">(meta, command, conf, cb)</span> -&gt;</span>
  <span class="hljs-keyword">if</span> command <span class="hljs-keyword">is</span> <span class="hljs-string">'help'</span>
    <span class="hljs-keyword">return</span> help meta, conf, cb</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>check for max execution</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  max = <span class="hljs-keyword">if</span> meta.daemon <span class="hljs-keyword">then</span> config.get <span class="hljs-string">'/mailman/daemon/maxJobs'</span> <span class="hljs-keyword">else</span> <span class="hljs-number">20</span>
  <span class="hljs-keyword">unless</span> numJobs &lt; max
    <span class="hljs-built_in">console</span>.error <span class="hljs-string">"skipping for this round (max <span class="hljs-subst">#{max}</span> jobs per round)"</span>
    <span class="hljs-keyword">return</span> cb()</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>check authentications</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">if</span> conf.filter?.from
    from = meta.header.from.toLowerCase()
    valid = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">for</span> test <span class="hljs-keyword">in</span> conf.filter?.from
      valid = ~from.indexOf test
      <span class="hljs-keyword">break</span> <span class="hljs-keyword">if</span> valid
    <span class="hljs-keyword">unless</span> valid
      <span class="hljs-built_in">console</span>.error <span class="hljs-string">"skipping invalid sender <span class="hljs-subst">#{from}</span>"</span>
      <span class="hljs-keyword">return</span> cb()</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>parse Options</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-built_in">console</span>.log <span class="hljs-string">"-&gt; execute <span class="hljs-subst">#{command}</span> for <span class="hljs-subst">#{meta.header.from}</span>"</span>
  bodyVariables conf, meta.body, <span class="hljs-function"><span class="hljs-params">(err, variables)</span> -&gt;</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>configure email</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    email = object.clone conf.email ? {<span class="hljs-attribute">base</span>: <span class="hljs-string">'default'</span>}
    email.to = [meta.header.from]
    email.subject = <span class="hljs-string">"Re: <span class="hljs-subst">#{meta.header.subject}</span>"</span>
    email.inReplyTo = meta.header[<span class="hljs-string">'message-id'</span>]
    email.references = [meta.header[<span class="hljs-string">'message-id'</span>]]</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>send error email</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">if</span> err
      <span class="hljs-keyword">return</span> mail.send email,
        <span class="hljs-attribute">name</span>: command
        <span class="hljs-attribute">conf</span>: conf
        <span class="hljs-attribute">date</span>: <span class="hljs-keyword">new</span> Date()
        <span class="hljs-attribute">result</span>:
          <span class="hljs-attribute">code</span>: <span class="hljs-number">1</span>
          <span class="hljs-attribute">error</span>: err.message
      , cb
    <span class="hljs-built_in">console</span>.log <span class="hljs-string">"   with"</span>, variables <span class="hljs-keyword">if</span> variables</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>add variables to command</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    variables ?= {}
    variables._mail =
      <span class="hljs-attribute">header</span>:
        <span class="hljs-attribute">from</span>: meta.header.from
    variables._json = JSON.stringify variables
    setup =
      <span class="hljs-attribute">remote</span>: conf.exec.remote
      <span class="hljs-attribute">cmd</span>: conf.exec.cmd
      <span class="hljs-attribute">args</span>: conf.exec.args.map (e) -&gt; e variables</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>priority: 'immediately'</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    Exec.run setup, <span class="hljs-function"><span class="hljs-params">(err, exec)</span> -&gt;</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>check if email should be send</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> conf.email
      <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> <span class="hljs-keyword">not</span> conf.email.onlyOnError <span class="hljs-keyword">or</span> exec.result.code</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>send email</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-built_in">console</span>.log chalk.grey <span class="hljs-string">'   sending mail response'</span>
      context =
        <span class="hljs-attribute">name</span>: command
        <span class="hljs-attribute">conf</span>: conf
        <span class="hljs-attribute">date</span>: <span class="hljs-keyword">new</span> Date()
        <span class="hljs-attribute">process</span>: exec.process
        <span class="hljs-attribute">result</span>: exec.result
      context.result.stdout = exec.stdout()
      context.result.stderr = exec.stderr()
      mail.send email, context, cb
<span class="hljs-function">
<span class="hljs-title">help</span> = <span class="hljs-params">(meta, conf, cb)</span> -&gt;</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>configure email</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  email = object.clone conf.email ? {<span class="hljs-attribute">base</span>: <span class="hljs-string">'default'</span>}
  email.to = [meta.header.from]
  email.subject = <span class="hljs-string">"Re: <span class="hljs-subst">#{meta.header.subject}</span>"</span>
  email.inReplyTo = meta.header[<span class="hljs-string">'message-id'</span>]
  email.references = [meta.header[<span class="hljs-string">'message-id'</span>]]
  email = mail.resolve email</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>setup internationalization</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  i18n = <span class="hljs-built_in">require</span> <span class="hljs-string">'i18n'</span>
  i18n.configure</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<p>locales: ['en', 'de'] # not needed since v0.7 will be autodetected</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-attribute">defaultLocale</span>: <span class="hljs-string">'en'</span>
    <span class="hljs-attribute">directory</span>: __dirname + <span class="hljs-string">'/../var/locales'</span>
    <span class="hljs-attribute">objectNotation</span>: <span class="hljs-literal">true</span>
  i18n.setLocale email.locale</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>create report</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  report = <span class="hljs-keyword">new</span> Report()
  report.toc()
  report.h2 i18n.__ <span class="hljs-string">"general.head:General Use"</span>
  report.p i18n.__ <span class="hljs-string">"general.text:To run one of the possible commands from Mailman
  you have to send a simple email to it's address under %s."</span>, meta.header.to
  report.h3 i18n.__ <span class="hljs-string">"auth.head:Authentification"</span>
  report.p i18n.__ <span class="hljs-string">"auth.text:This is done based on your email address. So you can
  only request what is available for your mail address. See the following list of
  possibilities for you."</span>
  report.h3 i18n.__ <span class="hljs-string">"select.head:Selection of Command"</span>
  report.p i18n.__ <span class="hljs-string">"select.text:You may select from the below listed commands by
  to execute by using different subject lines in your email. The subject is case
  insensitive but have to be correctly spelled."</span>
  report.h3 i18n.__ <span class="hljs-string">"var.head:Variables"</span>
  report.p i18n.__ <span class="hljs-string">"var.text:Some of the commands need or allow variables to be used.
  They have to be given in the body of your email in ini format. This means that
  you have to write the name of the variable, an equal sign and it's value in one
  line. The first empty line marks the end of the variables, all information below
  will be ignored. See the Examples below."</span>
  report.h3 i18n.__ <span class="hljs-string">"response.head:Response"</span>
  report.p i18n.__ <span class="hljs-string">"response.text:The concrete response may vary for each command.
  It can send you an email with the result, the problems or just be quiet. Sometimes
  the called command will interact with you directly like DBReports will do."</span>
  report.h3 i18n.__ <span class="hljs-string">"example.head:Examples"</span>
  report.p i18n.__ <span class="hljs-string">"example.simple:A question to DBReports for an database analyzation
  may look like:"</span>
  report.code <span class="hljs-string">"subject: last login\nbody: user_id = 52643"</span>
  report.p i18n.__ <span class="hljs-string">"example.list:Or if you want to call it with multiple IDs (if possible):"</span>
  report.code <span class="hljs-string">"subject: last login\nbody: user_id = 52643, 1285, 8854"</span>
  report.code <span class="hljs-string">"""
    subject: last login
    body: user_id[] = 52643
          user_id[] = 1285
          user_id[] = 8854
    """</span>
  report.p i18n.__ <span class="hljs-string">"example.footer:What your command allows will be described in
  the command help below."</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>search for allowed commands</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  report.h2 i18n.__ <span class="hljs-string">"command.head:Available Commands"</span>
  <span class="hljs-keyword">for</span> name, cmd <span class="hljs-keyword">of</span> config.get <span class="hljs-string">'/mailman/command'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<p>check for valid command</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    valid = cmd.filter?.from?.filter (e) -&gt; ~meta.header.from.toLowerCase().indexOf e
    <span class="hljs-keyword">continue</span> <span class="hljs-keyword">if</span> cmd.filter?.from <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> valid.length</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33"></a>
</div>
<p>create report entry</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    report.h3 cmd.title
    report.p cmd.description
    report.code <span class="hljs-string">"Subject: <span class="hljs-subst">#{cmd.filter.subject}</span>"</span>
    <span class="hljs-keyword">if</span> cmd.variables
      report.p i18n.__ <span class="hljs-string">"command.var:This command supports/needs some variables to be
      set within the contents:"</span>
      report.ul Object.keys(cmd.variables).map (key) -&gt;
        v = cmd.variables[key]
        msg = <span class="hljs-string">"`<span class="hljs-subst">#{key}</span>`"</span>
        msg += <span class="hljs-string">" - **<span class="hljs-subst">#{v.title}</span>**"</span> <span class="hljs-keyword">if</span> v.title
        msg += <span class="hljs-string">" (<span class="hljs-subst">#{i18n.__ <span class="hljs-string">'optional'</span>}</span>)"</span> <span class="hljs-keyword">if</span> v.optional <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> v.default
        msg += <span class="hljs-string">" (<span class="hljs-subst">#{i18n.__ <span class="hljs-string">'default'</span>}</span>: <span class="hljs-subst">#{v.default}</span>)"</span> <span class="hljs-keyword">if</span> v.default
        msg += <span class="hljs-string">"\\\n<span class="hljs-subst">#{v.description}</span>"</span> <span class="hljs-keyword">if</span> v.description
        msg += <span class="hljs-string">"\\\n<span class="hljs-subst">#{i18n.__ <span class="hljs-string">'Type'</span>}</span>: "</span> + <span class="hljs-keyword">switch</span> v.type
          <span class="hljs-keyword">when</span> <span class="hljs-string">'array'</span>
            i18n.__ <span class="hljs-string">"command.list:List of %s"</span>, v.entries?.type ? i18n.__ <span class="hljs-string">'entries'</span>
          <span class="hljs-keyword">else</span>
            v.type
        <span class="hljs-keyword">if</span> v.delimiter
          del = v.delimiter.toString()
          <span class="hljs-keyword">if</span> match = del.match <span class="hljs-regexp">/^\/(.*)\/([gim]+)?$/</span>
            del = match[<span class="hljs-number">1</span>].replace <span class="hljs-regexp">/\\[srt ]\*/g</span>, <span class="hljs-string">''</span>
            .replace <span class="hljs-regexp">/\\s\+?/g</span>, <span class="hljs-string">' '</span>
            .replace <span class="hljs-regexp">/\\t\+?/g</span>, <span class="hljs-string">'TAB'</span>
            .split <span class="hljs-regexp">/\|/</span>
            .join <span class="hljs-string">"', '"</span>
          msg += <span class="hljs-string">" ("</span> + i18n.__(<span class="hljs-string">"use '%s' as delimiter"</span>, del) + <span class="hljs-string">")"</span>
        msg
  report.h2 i18n.__ <span class="hljs-string">"final.head:Further Help"</span>
  report.p i18n.__ <span class="hljs-string">"final.text:If something goes wrong or you need further help
  send an email as reply to this."</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<p>send help email</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  mail.send email,
    <span class="hljs-attribute">name</span>: <span class="hljs-string">'help'</span>
    <span class="hljs-attribute">conf</span>: conf
    <span class="hljs-attribute">date</span>: <span class="hljs-keyword">new</span> Date()
    <span class="hljs-attribute">help</span>: report.toString()
  , cb</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
